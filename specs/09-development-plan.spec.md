# AI Society 完整开发计划

## 项目信息

| 项目 | 说明 |
|------|------|
| 项目名称 | AI Society |
| GitHub仓库 | AI-Society |
| 开源协议 | OpenRAIL |
| 部署环境 | 阿里云 ECS |
| 默认AI模型 | DeepSeek R1 |
| 月度预算 | $200 USD |
| 开发方式 | Subagent-Driven（逐任务派遣、逐任务审查） |

---

## 核心设计决策（已确认）

### 1. AI决策方式
- **全AI决策**：所有智能体行为都由AI决定
- **不使用规则引擎**：即使"饿了吃饭"也由AI思考决定
- **理由**：更接近真实人类行为，观察价值更高

### 2. 模型配置
- **默认模型**：DeepSeek R1（推理模型）
- **支持修改**：可针对单个智能体切换其他模型
- **可选模型**：DeepSeek Chat、GPT-4o、Claude、本地Ollama

### 3. 时间系统
- **时间缩放**：现实1分钟 = 游戏内10分钟
- **决策频率**：每游戏内10分钟决策1次（现实1分钟）
- **日夜循环**：06:00日出，22:00夜晚

### 4. 经济系统
- **现实对齐**：参考中国一线城市生活水平
- **日均开销**：185元（房租+吃饭+交通）
- **程序员时薪**：150元

### 5. 成本控制
- **月度预算**：$200 USD
- **预估消耗**：$150-200/月（50智能体全R1）
- **控制策略**：缓存、批量、动态调频

---

## 开发阶段总览

```
┌─────────────────────────────────────────────────────────────────┐
│  阶段0: 项目初始化                                    [第1天]   │
│  └─> GitHub仓库、目录结构、Docker环境                          │
├─────────────────────────────────────────────────────────────────┤
│  阶段1: 后端核心框架                                  [第1-3天] │
│  └─> FastAPI、世界时钟、事件总线、基础API                      │
├─────────────────────────────────────────────────────────────────┤
│  阶段2: LLM抽象层                                     [第3-5天] │
│  └─> 多模型路由、DeepSeek R1集成、成本统计                     │
├─────────────────────────────────────────────────────────────────┤
│  阶段3: 智能体系统                                    [第5-12天]│
│  └─> 全AI决策引擎、需求系统、经济系统、50个智能体              │
├─────────────────────────────────────────────────────────────────┤
│  阶段4: 对话系统                                      [第12-16天]│
│  └─> 对话触发、AI生成、关系影响、实时推送                      │
├─────────────────────────────────────────────────────────────────┤
│  阶段5: 前端基础                                      [第16-20天]│
│  └─> React+Pixi.js、地图渲染、智能体显示、WebSocket            │
├─────────────────────────────────────────────────────────────────┤
│  阶段6: 前端完善                                      [第20-24天]│
│  └─> 对话气泡、详情面板、统计图表、社交网络图                  │
├─────────────────────────────────────────────────────────────────┤
│  阶段7: 持久化存储                                    [第24-27天]│
│  └─> PostgreSQL、向量记忆、状态恢复、数据导出                  │
├─────────────────────────────────────────────────────────────────┤
│  阶段8: 自动扩展                                      [第27-29天]│
│  └─> 职业缺口检测、AI生成新智能体、人口平衡                    │
├─────────────────────────────────────────────────────────────────┤
│  阶段9: 部署与开源                                    [第29-32天]│
│  └─> Docker部署、阿里云上线、开源文档、v0.1.0发布              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 阶段0: 项目初始化

### 目标
搭建开发环境，初始化项目结构

### 任务清单

| ID | 任务 | 时间 | 验收标准 |
|----|------|------|----------|
| 0.1 | 创建GitHub仓库 AI-Society | 15min | 仓库可访问 |
| 0.2 | 初始化后端Python项目（Poetry） | 30min | pyproject.toml完整 |
| 0.3 | 创建后端目录结构 | 30min | 符合架构Spec |
| 0.4 | 初始化前端React项目（Vite） | 20min | npm run dev可启动 |
| 0.5 | 编写docker-compose.yml | 30min | PostgreSQL+Redis可启动 |
| 0.6 | 配置.env.example | 15min | 包含DeepSeek API Key占位 |
| 0.7 | 配置.gitignore | 10min | 敏感文件不提交 |
| 0.8 | 创建LICENSE（OpenRAIL） | 10min | 协议文件存在 |

### 目录结构

```
ai-society/
├── backend/
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py
│   │   ├── core/
│   │   │   ├── __init__.py
│   │   │   ├── config.py
│   │   │   ├── world.py
│   │   │   ├── agent.py
│   │   │   ├── economy.py
│   │   │   └── events.py
│   │   ├── llm/
│   │   │   ├── __init__.py
│   │   │   ├── router.py
│   │   │   ├── deepseek.py
│   │   │   └── prompts.py
│   │   ├── services/
│   │   ├── routes/
│   │   ├── models/
│   │   └── schemas/
│   ├── data/
│   ├── tests/
│   ├── pyproject.toml
│   └── Dockerfile
├── frontend/
│   ├── src/
│   ├── public/
│   ├── package.json
│   └── Dockerfile
├── docker-compose.yml
├── .env.example
├── .gitignore
└── LICENSE
```

### 交付物
- [x] GitHub仓库地址
- [x] 本地环境可运行
- [x] Docker服务可启动

---

## 阶段1: 后端核心框架

### 目标
搭建后端基础架构，实现世界时钟和基础API

### 任务清单

| ID | 任务 | 时间 | 依赖 | 验收标准 |
|----|------|------|------|----------|
| 1.1 | 实现config.py配置管理 | 1h | 0.x | 配置可读取，支持环境变量 |
| 1.2 | 实现WorldClock时间系统 | 2h | 1.1 | 时间缩放正确(1:10) |
| 1.3 | 实现Location数据结构 | 1h | 1.1 | 位置模型完整 |
| 1.4 | 创建locations.json配置 | 2h | 1.3 | 10+位置配置完整 |
| 1.5 | 实现EventBus事件总线 | 2h | 1.1 | 发布订阅可用 |
| 1.6 | 实现FastAPI基础应用 | 1h | 1.1-1.5 | 应用可启动 |
| 1.7 | 实现/api/world/status端点 | 1h | 1.6 | 返回世界状态 |
| 1.8 | 实现WebSocket端点 | 2h | 1.5 | WS连接可建立 |
| 1.9 | 编写单元测试 | 2h | 1.1-1.8 | 测试通过率100% |

### 关键代码设计

```python
# config.py - 核心配置
class Settings(BaseSettings):
    # 时间系统
    time_scale: int = 10  # 现实1分钟 = 游戏10分钟
    
    # DeepSeek配置
    deepseek_api_key: str  # 从环境变量读取
    deepseek_base_url: str = "https://api.deepseek.com"
    default_model: str = "deepseek-reasoner"  # 默认R1
    
    # 成本控制
    monthly_budget: float = 200.0
    
# world.py - 世界时钟
class WorldClock:
    time_scale: int = 10
    
    def now(self) -> datetime:
        """返回游戏内时间"""
        real_delta = datetime.now(UTC) - self.start_real_time
        world_delta = real_delta * self.time_scale
        return self.start_world_time + world_delta
```

### 验收标准
- `GET /api/world/status` 返回正确的世界时间
- WebSocket可建立连接并接收测试事件
- 单元测试100%通过

---

## 阶段2: LLM抽象层

### 目标
实现多模型支持，集成DeepSeek R1作为默认模型

### 任务清单

| ID | 任务 | 时间 | 依赖 | 验收标准 |
|----|------|------|------|----------|
| 2.1 | 定义LLMAdapter抽象接口 | 1h | 1.x | 接口定义完整 |
| 2.2 | 实现DeepSeekAdapter(R1+Chat) | 3h | 2.1 | R1调用成功 |
| 2.3 | 实现LLMRouter路由器 | 2h | 2.2 | 根据模型名路由 |
| 2.4 | 实现提示词模板管理 | 2h | 2.1 | 模板可配置加载 |
| 2.5 | 实现调用频率限制 | 1h | 2.3 | 避免超出API限制 |
| 2.6 | 实现成本统计服务 | 2h | 2.3 | 可查看token消耗 |
| 2.7 | 实现缓存机制 | 2h | 2.3 | 相似请求复用 |
| 2.8 | 编写集成测试 | 2h | 2.1-2.7 | 测试通过 |

### 关键代码设计

```python
# router.py - 多模型路由
class LLMRouter:
    def __init__(self):
        self.adapters: Dict[str, LLMAdapter] = {}
        self.cost_tracker = CostTracker()
    
    async def generate(self, model_name: str, prompt: str) -> str:
        """调用指定模型生成响应"""
        adapter = self.adapters.get(model_name)
        if not adapter:
            raise ValueError(f"未知模型: {model_name}")
        
        # 检查预算
        if self.cost_tracker.monthly_total > MONTHLY_BUDGET * 0.9:
            logger.warning("接近月度预算上限")
        
        # 调用模型
        response, tokens = await adapter.generate(prompt)
        
        # 记录成本
        self.cost_tracker.record(model_name, tokens)
        
        return response

# deepseek.py - DeepSeek适配器
class DeepSeekAdapter(LLMAdapter):
    async def generate(self, prompt: str) -> Tuple[str, TokenUsage]:
        response = await self.client.chat.completions.create(
            model="deepseek-reasoner",  # R1模型
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices[0].message.content, response.usage
```

### 验收标准
- 能成功调用DeepSeek R1并返回结果
- LLMRouter能正确路由到不同模型
- 成本统计能准确记录token消耗

---

## 阶段3: 智能体系统（核心）

### 目标
实现智能体全AI决策引擎，创建50个初始智能体

### 任务清单

| ID | 任务 | 时间 | 依赖 | 验收标准 |
|----|------|------|------|----------|
| 3.1 | 实现AgentProfile模型 | 2h | 1.x | 属性完整 |
| 3.2 | 实现Personality大五人格 | 1h | 3.1 | 5维人格模型 |
| 3.3 | 实现Needs需求系统 | 2h | 3.1 | 被动衰减逻辑 |
| 3.4 | 实现Economy经济系统 | 3h | 3.1 | 收入支出逻辑 |
| 3.5 | 实现AgentContext上下文构建 | 3h | 3.1-3.4 | 上下文完整 |
| 3.6 | 实现决策提示词模板 | 3h | 2.4 | 模板支持全AI决策 |
| 3.7 | **实现AgentEngine决策引擎** | 8h | 2.x,3.1-3.6 | **全AI决策可用** |
| 3.8 | 实现决策解析器 | 2h | 3.7 | 解析AI响应 |
| 3.9 | 实现行为执行系统 | 3h | 3.7-3.8 | 决策能执行 |
| 3.10 | 实现移动系统(A*寻路) | 4h | 1.3 | 智能体能移动 |
| 3.11 | 实现智能体生成器 | 4h | 2.x,3.1 | AI生成新智能体 |
| 3.12 | 创建初始50个智能体 | 3h | 3.11 | 智能体数据完整 |
| 3.13 | 实现智能体API端点 | 2h | 3.1-3.12 | CRUD API可用 |
| 3.14 | 编写单元测试 | 4h | 3.1-3.13 | 测试通过 |

### 关键代码设计

```python
# agent_engine.py - 全AI决策引擎（核心）
class AgentEngine:
    """
    智能体决策引擎
    重要：所有行为决策都由AI做出，不使用规则引擎
    """
    
    async def decision_loop(self, agent: AgentState):
        """智能体决策循环"""
        while agent.is_active:
            # 1. 构建完整上下文
            context = await self.build_context(agent)
            
            # 2. 调用AI做决策（核心：全部交给AI）
            decision = await self.ai_decide(agent, context)
            
            # 3. 更新智能体的"当前想法"（观察者可见）
            agent.current_thinking = decision.thinking
            
            # 4. 执行决策
            await self.execute_decision(agent, decision)
            
            # 5. 被动需求衰减
            self.passive_needs_decay(agent)
            
            # 6. 等待下一个决策周期（现实60秒）
            await asyncio.sleep(60)
    
    async def ai_decide(self, agent: AgentState, context: AgentContext) -> AgentDecision:
        """调用AI做决策"""
        prompt = self.build_full_ai_prompt(agent, context)
        response = await self.llm_router.generate(agent.model_name, prompt)
        return self.parse_decision(response)
```

### 验收标准
- 1个智能体能在地图上自主移动
- 智能体能根据AI决策做出多样化行为
- 50个智能体能同时运行

---

## 阶段4: 对话系统

### 目标
实现智能体之间的自然对话，这是观察的核心

### 任务清单

| ID | 任务 | 时间 | 依赖 | 验收标准 |
|----|------|------|------|----------|
| 4.1 | 实现对话触发检测 | 3h | 3.x | 近距离触发对话 |
| 4.2 | 实现Conversation会话管理 | 3h | 4.1 | 会话状态管理 |
| 4.3 | 实现对话开场白生成 | 3h | 2.x | AI生成开场 |
| 4.4 | 实现对话回复生成 | 3h | 2.x | AI生成回复 |
| 4.5 | 实现对话轮次控制 | 2h | 4.2-4.4 | 控制对话长度 |
| 4.6 | 实现对话结束检测 | 2h | 4.5 | 自然结束对话 |
| 4.7 | 实现情绪检测 | 2h | 4.4 | 分析对话情绪 |
| 4.8 | 实现话题提取 | 2h | 4.4 | 提取对话话题 |
| 4.9 | 实现关系影响计算 | 3h | 4.6-4.8 | 对话影响关系 |
| 4.10 | 实现对话API端点 | 2h | 4.1-4.9 | 查询对话API |
| 4.11 | 实现对话WebSocket推送 | 2h | 4.10 | 实时推送对话 |
| 4.12 | 编写测试 | 3h | 4.1-4.11 | 测试通过 |

### 验收标准
- 两个智能体相遇时能自动开始对话
- 对话内容自然，符合角色性格
- 对话结束后关系值正确变化
- 前端能实时收到对话消息

---

## 阶段5: 前端基础

### 目标
实现可视化界面，能观察智能体

### 任务清单

| ID | 任务 | 时间 | 依赖 | 验收标准 |
|----|------|------|------|----------|
| 5.1 | 配置TailwindCSS | 30min | 0.4 | 样式可用 |
| 5.2 | 实现主布局(TopBar+Main+Side) | 2h | 5.1 | 布局完成 |
| 5.3 | 集成Pixi.js | 2h | 0.4 | Canvas可渲染 |
| 5.4 | 实现WorldMap组件 | 6h | 5.3 | 地图可显示 |
| 5.5 | 实现位置渲染 | 3h | 5.4 | 建筑物可见 |
| 5.6 | 实现智能体精灵 | 4h | 5.4 | 智能体可见 |
| 5.7 | 实现地图缩放/拖拽 | 3h | 5.4 | 交互可用 |
| 5.8 | 实现Zustand状态管理 | 3h | 0.4 | 状态管理可用 |
| 5.9 | 实现WebSocket连接 | 3h | 5.8 | 实时数据接收 |
| 5.10 | 实现智能体列表面板 | 3h | 5.8 | 列表可显示 |
| 5.11 | 实现事件流面板 | 3h | 5.9 | 事件实时显示 |

### 验收标准
- 能看到2D地图和建筑物
- 能看到智能体在地图上移动
- 能看到实时事件流

---

## 阶段6: 前端完善

### 目标
完善观察界面，增加详情和统计

### 任务清单

| ID | 任务 | 时间 | 依赖 | 验收标准 |
|----|------|------|------|----------|
| 6.1 | 实现对话气泡 | 4h | 5.6 | 气泡可显示 |
| 6.2 | 实现智能体详情面板 | 4h | 5.10 | 详情完整 |
| 6.3 | 实现性格/状态可视化 | 2h | 6.2 | 进度条可视化 |
| 6.4 | 实现关系列表 | 2h | 6.2 | 关系可见 |
| 6.5 | 实现记忆列表 | 2h | 6.2 | 记忆可见 |
| 6.6 | 实现统计面板 | 4h | 5.8 | 统计数据显示 |
| 6.7 | 实现职业分布图 | 2h | 6.6 | 饼图可见 |
| 6.8 | 实现社交网络图 | 6h | 5.8 | 力导向图可交互 |
| 6.9 | 实现时间控制(暂停/加速) | 2h | 5.2 | 控制可用 |
| 6.10 | 实现跟随智能体功能 | 2h | 5.6 | 地图跟随 |
| 6.11 | UI美化和动画 | 4h | 6.1-6.10 | 视觉效果好 |

### 验收标准
- 点击智能体能看到完整详情（包括当前想法）
- 能看到社交网络关系图
- 界面美观，交互流畅

---

## 阶段7: 持久化存储

### 目标
实现数据持久化和记忆系统

### 任务清单

| ID | 任务 | 时间 | 依赖 | 验收标准 |
|----|------|------|------|----------|
| 7.1 | 设计数据库Schema | 2h | - | ER图完整 |
| 7.2 | 实现SQLAlchemy模型 | 4h | 7.1 | 模型完整 |
| 7.3 | 实现Alembic迁移 | 2h | 7.2 | 迁移可执行 |
| 7.4 | 实现智能体CRUD | 3h | 7.2 | 增删改查可用 |
| 7.5 | 实现对话存储 | 2h | 7.2 | 对话可存储 |
| 7.6 | 实现关系存储 | 2h | 7.2 | 关系可存储 |
| 7.7 | 集成Qdrant向量库 | 3h | - | 向量库可用 |
| 7.8 | 实现记忆向量化存储 | 4h | 7.7 | 记忆可存储 |
| 7.9 | 实现记忆检索 | 3h | 7.8 | 相关记忆可检索 |
| 7.10 | 实现世界状态保存/恢复 | 3h | 7.4-7.6 | 重启可恢复 |
| 7.11 | 实现数据导出API | 3h | 7.4-7.6 | CSV/JSON导出 |

### 验收标准
- 服务重启后世界状态能恢复
- 智能体能检索相关记忆用于决策
- 数据能导出为CSV/JSON/GraphML

---

## 阶段8: 自动扩展

### 目标
实现智能体自动创建和社会平衡

### 任务清单

| ID | 任务 | 时间 | 依赖 | 验收标准 |
|----|------|------|------|----------|
| 8.1 | 实现职业缺口检测 | 3h | 3.x | 能检测缺口 |
| 8.2 | 实现社交孤岛检测 | 2h | 4.x | 能检测孤独者 |
| 8.3 | 实现人口平衡检测 | 2h | 3.x | 能检测失衡 |
| 8.4 | 实现AI生成新智能体 | 4h | 2.x | 能生成角色 |
| 8.5 | 实现智能体融入逻辑 | 3h | 8.4 | 新人能融入 |
| 8.6 | 实现智能体离开机制 | 2h | 3.x | 条件满足离开 |
| 8.7 | 实现人口上限控制 | 1h | 8.4-8.6 | 人口可控 |
| 8.8 | 实现定时检查任务 | 2h | 8.1-8.3 | 定时执行 |
| 8.9 | 前端显示新增/离开事件 | 2h | 8.4-8.6 | 事件可见 |

### 验收标准
- 咖啡馆人多时会自动创建服务员
- 孤独的智能体会获得匹配的朋友
- 系统能维持健康的人口结构

---

## 阶段9: 部署与开源

### 目标
完成阿里云部署和开源准备

### 任务清单

| ID | 任务 | 时间 | 依赖 | 验收标准 |
|----|------|------|------|----------|
| 9.1 | 编写Dockerfile(后端) | 2h | - | 镜像可构建 |
| 9.2 | 编写Dockerfile(前端) | 1h | - | 镜像可构建 |
| 9.3 | 完善docker-compose.yml | 2h | 9.1-9.2 | 一键启动 |
| 9.4 | 配置阿里云ECS | 2h | - | 服务器就绪 |
| 9.5 | 部署到阿里云 | 2h | 9.3-9.4 | 线上可访问 |
| 9.6 | 配置域名和HTTPS | 1h | 9.5 | HTTPS可用 |
| 9.7 | 代码注释完善 | 4h | - | 中文注释完整 |
| 9.8 | 编写README.md | 2h | - | README完整 |
| 9.9 | 编写CONTRIBUTING.md | 1h | - | 贡献指南完整 |
| 9.10 | 创建Issues模板 | 30min | - | 模板可用 |
| 9.11 | 首次发布Release | 1h | 9.1-9.10 | v0.1.0发布 |

### 阿里云配置建议

```
推荐配置（50智能体）：
- 实例类型: ecs.c6.xlarge
- CPU: 4核
- 内存: 8GB
- 系统盘: 40GB SSD
- 带宽: 5Mbps
- 预估月费: ¥300-400

服务部署：
- Nginx: 反向代理 + HTTPS
- PostgreSQL: 数据库
- Redis: 缓存
- Qdrant: 向量数据库（可选Docker部署）
- Backend: FastAPI应用
- Frontend: 静态文件（Nginx托管）
```

### 验收标准
- 线上服务稳定运行
- 任何人可以按README部署
- GitHub仓库开源就绪

---

## 里程碑

| 里程碑 | 日期 | 交付物 | 验收要点 |
|--------|------|--------|----------|
| **M0** | 第1天 | 项目初始化 | 仓库可访问，环境可运行 |
| **M1** | 第5天 | 核心框架+LLM | API可访问，DeepSeek R1可调用 |
| **M2** | 第12天 | 智能体可运行 | 50智能体全AI决策自主活动 |
| **M3** | 第16天 | 对话可观察 | 智能体对话实时可见 |
| **M4** | 第20天 | 前端基础 | 2D地图+智能体显示 |
| **M5** | 第27天 | 功能完整 | 完整观察体验+数据持久化 |
| **M6** | 第32天 | 开源发布 | v0.1.0上线阿里云 |

---

## 风险与应对

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| LLM成本超预算 | 中 | 高 | 启用缓存，动态调整决策频率 |
| R1响应慢影响体验 | 中 | 中 | 异步处理，前端显示"思考中" |
| 50智能体性能问题 | 中 | 中 | 分批决策，优先处理可见区域 |
| 对话质量不稳定 | 中 | 中 | 优化提示词，增加上下文 |
| DeepSeek API不稳定 | 低 | 高 | 重试机制，备用模型切换 |

---

## 协作方式

采用 **Subagent-Driven** 模式：

1. **任务派遣**: 每个任务ID对应一次独立执行
2. **逐任务审查**: 完成一个任务后请你确认再继续
3. **代码风格**: 低耦合、中文详细注释
4. **测试规范**: 核心逻辑先写单元测试

---

## 环境变量配置

```bash
# .env.example
# DeepSeek API
DEEPSEEK_API_KEY=sk-491fac522ea14822b37f6547a7a36141
DEEPSEEK_BASE_URL=https://api.deepseek.com

# 数据库
DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/aisociety

# Redis
REDIS_URL=redis://localhost:6379/0

# 向量数据库
QDRANT_URL=http://localhost:6333

# 世界配置
TIME_SCALE=10
DEFAULT_MODEL=deepseek-reasoner
MONTHLY_BUDGET=200
```

---

## 确认清单

请确认以下内容无误：

- [ ] 项目名称: AI Society
- [ ] 默认模型: DeepSeek R1
- [ ] 决策方式: 全AI决策（无规则引擎）
- [ ] 时间缩放: 1:10
- [ ] 初始智能体: 50个
- [ ] 月度预算: $200 USD
- [ ] 部署环境: 阿里云 ECS
- [ ] 开发方式: 先后端再前端
- [ ] 协作模式: Subagent-Driven

---

**确认无误后，告诉我，我将从阶段0任务0.1开始执行。**
