# 实施计划规格说明

## 项目概览

| 项目 | 说明 |
|------|------|
| 项目名称 | AI Society |
| 目标 | 开源AI自治世界观察实验平台 |
| 预计工期 | 6周(MVP) + 持续迭代 |
| 开源协议 | OpenRAIL |
| 仓库 | GitHub: AI-Society |

## 开发原则

1. **稳步推进**: 每个阶段都要跑通验证,不留隐患
2. **低耦合**: 模块之间松耦合,便于独立开发和测试
3. **中文注释**: 代码注释使用中文,便于理解和维护
4. **先自动化测试**: 核心逻辑优先写单元测试
5. **渐进交付**: 每个阶段都有可运行的Demo

## 开发阶段

### 阶段0: 项目初始化 (第1天)

**目标**: 搭建开发环境,初始化项目结构

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 验收标准 |
|--------|----------|----------|----------|
| 0.1 | 创建GitHub仓库 AI-Society | 15分钟 | 仓库可访问 |
| 0.2 | 初始化后端Python项目结构 | 30分钟 | 目录结构完整 |
| 0.3 | 初始化前端React项目(Vite) | 30分钟 | `npm run dev` 能启动 |
| 0.4 | 编写 docker-compose.yml | 30分钟 | PostgreSQL+Redis能启动 |
| 0.5 | 配置 .env.example | 15分钟 | 环境变量模板完整 |
| 0.6 | 配置 .gitignore | 10分钟 | 敏感文件不提交 |
| 0.7 | 创建 LICENSE (OpenRAIL) | 10分钟 | 协议文件存在 |

#### 交付物
- 可clone的GitHub仓库
- 本地开发环境可运行

---

### 阶段1: 后端核心框架 (第1-3天)

**目标**: 搭建后端基础架构,实现世界时钟和基础API

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 依赖 | 验收标准 |
|--------|----------|----------|------|----------|
| 1.1 | 实现 config.py 配置管理 | 1小时 | 0.x | 配置可读取 |
| 1.2 | 实现 WorldClock 时间系统 | 2小时 | 1.1 | 时间缩放正确(1:10) |
| 1.3 | 实现 AgentState 数据结构 | 2小时 | 1.1 | 数据模型完整 |
| 1.4 | 实现 Location 数据结构 | 1小时 | 1.1 | 位置模型完整 |
| 1.5 | 创建 locations.json 配置 | 2小时 | 1.4 | 地图位置配置完整 |
| 1.6 | 实现 EventBus 事件总线 | 2小时 | 1.1 | 事件发布订阅可用 |
| 1.7 | 实现 FastAPI 基础路由 | 2小时 | 1.1-1.6 | /api/world/status 可访问 |
| 1.8 | 实现 WebSocket 端点 | 2小时 | 1.6-1.7 | WS连接可建立 |
| 1.9 | 编写单元测试 | 3小时 | 1.1-1.8 | 测试通过率100% |

#### 核心代码

```python
# app/core/config.py
class Settings(BaseSettings):
    time_scale: int = 10
    database_url: str
    deepseek_api_key: str
    # ...

# app/core/world.py
class WorldClock:
    def now(self) -> datetime:
        """返回游戏内时间"""
        real_delta = datetime.now() - self.start_real_time
        return self.start_world_time + real_delta * self.time_scale

# app/core/events.py
class EventBus:
    async def publish(self, event: Event):
        """发布事件到所有订阅者"""
        for subscriber in self.subscribers:
            await subscriber(event)
```

#### 验收标准
- `GET /api/world/status` 返回正确的世界时间
- WebSocket连接可建立并接收测试事件
- 单元测试全部通过

---

### 阶段2: LLM抽象层 (第3-5天)

**目标**: 实现多模型支持,能调用DeepSeek等模型

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 依赖 | 验收标准 |
|--------|----------|----------|------|----------|
| 2.1 | 定义 LLMAdapter 抽象接口 | 1小时 | 1.x | 接口定义完整 |
| 2.2 | 实现 DeepSeekAdapter | 3小时 | 2.1 | 能调用DeepSeek Chat |
| 2.3 | 实现 DeepSeekReasonerAdapter | 2小时 | 2.1 | 能调用DeepSeek R1 |
| 2.4 | 实现 OpenAIAdapter (可选) | 2小时 | 2.1 | 能调用GPT-4o |
| 2.5 | 实现 LLMRouter 路由器 | 2小时 | 2.2-2.4 | 根据模型名路由 |
| 2.6 | 实现提示词模板管理 | 2小时 | 2.1 | 模板可配置 |
| 2.7 | 实现调用频率限制 | 1小时 | 2.5 | 避免超出API限制 |
| 2.8 | 实现调用成本统计 | 1小时 | 2.5 | 可查看API消费 |
| 2.9 | 编写集成测试 | 2小时 | 2.1-2.8 | 测试通过 |

#### 核心代码

```python
# app/llm/router.py
class LLMRouter:
    adapters: Dict[str, LLMAdapter] = {}
    
    def register(self, name: str, adapter: LLMAdapter):
        self.adapters[name] = adapter
    
    async def generate(self, model_name: str, prompt: str) -> str:
        adapter = self.adapters.get(model_name)
        if not adapter:
            raise ValueError(f"未知模型: {model_name}")
        return await adapter.generate(prompt)

# app/llm/deepseek.py
class DeepSeekAdapter(LLMAdapter):
    async def generate(self, prompt: str) -> str:
        response = await self.client.chat.completions.create(
            model="deepseek-chat",
            messages=[{"role": "user", "content": prompt}]
        )
        return response.choices[0].message.content
```

#### 验收标准
- 能成功调用DeepSeek Chat API并返回结果
- LLMRouter能根据模型名称正确路由
- 有基本的错误处理和重试机制

---

### 阶段3: 智能体系统 (第5-10天)

**目标**: 实现智能体核心逻辑,能自主决策和移动

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 依赖 | 验收标准 |
|--------|----------|----------|------|----------|
| 3.1 | 实现 AgentProfile 模型 | 2小时 | 1.3 | 属性完整 |
| 3.2 | 实现 Personality 大五人格 | 1小时 | 3.1 | 5维人格模型 |
| 3.3 | 实现 Needs 需求系统 | 2小时 | 3.1 | 需求衰减逻辑 |
| 3.4 | 实现 Economy 经济系统 | 3小时 | 3.1 | 收入支出逻辑 |
| 3.5 | 实现 AgentEngine 决策引擎 | 6小时 | 2.x, 3.1-3.4 | 能做决策 |
| 3.6 | 实现规则决策(不调LLM) | 3小时 | 3.5 | 简单决策用规则 |
| 3.7 | 实现LLM决策 | 4小时 | 3.5 | 复杂决策调LLM |
| 3.8 | 实现移动系统(A*寻路) | 4小时 | 1.4 | 智能体能移动 |
| 3.9 | 实现行为执行系统 | 3小时 | 3.5-3.8 | 决策能执行 |
| 3.10 | 实现智能体生成器 | 4小时 | 2.x, 3.1 | AI生成新智能体 |
| 3.11 | 创建初始50个智能体 | 3小时 | 3.10 | 智能体数据完整 |
| 3.12 | 编写单元测试 | 4小时 | 3.1-3.11 | 测试通过 |

#### 核心代码

```python
# app/core/agent_engine.py
class AgentEngine:
    async def decision_loop(self, agent: AgentState):
        """智能体决策循环"""
        while True:
            # 1. 更新需求
            self.update_needs(agent)
            
            # 2. 检查紧急需求(规则)
            urgent_action = self.check_urgent_needs(agent)
            if urgent_action:
                await self.execute_action(agent, urgent_action)
                continue
            
            # 3. 检查日程(规则)
            scheduled_action = self.check_schedule(agent)
            if scheduled_action:
                await self.execute_action(agent, scheduled_action)
                continue
            
            # 4. 主动决策(LLM)
            if self.should_make_decision(agent):
                decision = await self.make_decision(agent)
                await self.execute_action(agent, decision)
            
            # 5. 等待下一个决策周期
            await asyncio.sleep(self.decision_interval)
```

#### 验收标准
- 1个智能体能在地图上自主移动
- 智能体能根据需求做出合理决策
- 能量低时会去吃饭,到点会去上班

---

### 阶段4: 对话系统 (第10-14天)

**目标**: 实现智能体之间的自然对话

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 依赖 | 验收标准 |
|--------|----------|----------|------|----------|
| 4.1 | 实现对话触发检测 | 3小时 | 3.x | 近距离触发对话 |
| 4.2 | 实现 Conversation 会话管理 | 3小时 | 4.1 | 会话状态管理 |
| 4.3 | 实现对话开场白生成 | 3小时 | 2.x, 4.2 | LLM生成开场 |
| 4.4 | 实现对话回复生成 | 3小时 | 2.x, 4.2 | LLM生成回复 |
| 4.5 | 实现对话轮次控制 | 2小时 | 4.2-4.4 | 控制对话长度 |
| 4.6 | 实现对话结束检测 | 2小时 | 4.5 | 自然结束对话 |
| 4.7 | 实现情绪检测 | 2小时 | 4.4 | 分析对话情绪 |
| 4.8 | 实现话题提取 | 2小时 | 4.4 | 提取对话话题 |
| 4.9 | 实现关系影响计算 | 3小时 | 4.6-4.8 | 对话影响关系 |
| 4.10 | 实现对话API端点 | 2小时 | 4.1-4.9 | API可查询对话 |
| 4.11 | 实现对话WebSocket推送 | 2小时 | 4.10 | 实时推送对话 |
| 4.12 | 编写测试 | 3小时 | 4.1-4.11 | 测试通过 |

#### 核心代码

```python
# app/services/chat_service.py
class ChatService:
    async def process_conversation(self, conv: Conversation):
        """处理一次对话"""
        while conv.state != ConversationState.ENDED:
            # 获取当前说话人
            speaker = self.get_current_speaker(conv)
            
            # 生成对话
            message = await self.generate_message(speaker, conv)
            conv.messages.append(message)
            
            # 广播消息
            await self.event_bus.publish(ConversationMessageEvent(conv, message))
            
            # 检查是否结束
            if self.should_end(conv, message):
                conv.state = ConversationState.ENDED
                break
            
            # 切换说话人
            self.switch_speaker(conv)
            
            # 间隔
            await asyncio.sleep(self.turn_interval)
        
        # 更新关系
        await self.update_relationships(conv)
```

#### 验收标准
- 两个智能体相遇时能自动开始对话
- 对话内容自然,符合角色性格
- 对话结束后关系值正确变化

---

### 阶段5: 前端基础 (第14-18天)

**目标**: 实现可视化界面,能观察智能体

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 依赖 | 验收标准 |
|--------|----------|----------|------|----------|
| 5.1 | 搭建React + Vite项目 | 1小时 | 0.3 | 项目可运行 |
| 5.2 | 配置TailwindCSS | 30分钟 | 5.1 | 样式可用 |
| 5.3 | 实现主布局(TopBar+Main) | 2小时 | 5.2 | 布局完成 |
| 5.4 | 集成Pixi.js | 2小时 | 5.1 | Canvas可渲染 |
| 5.5 | 实现WorldMap组件 | 6小时 | 5.4 | 地图可显示 |
| 5.6 | 实现位置渲染 | 3小时 | 5.5 | 建筑物可见 |
| 5.7 | 实现智能体精灵 | 4小时 | 5.5 | 智能体可见 |
| 5.8 | 实现地图缩放/拖拽 | 3小时 | 5.5 | 交互可用 |
| 5.9 | 实现Zustand状态管理 | 3小时 | 5.1 | 状态管理可用 |
| 5.10 | 实现WebSocket连接 | 3小时 | 5.9 | 实时数据接收 |
| 5.11 | 实现智能体列表面板 | 3小时 | 5.9 | 列表可显示 |
| 5.12 | 实现事件流面板 | 3小时 | 5.10 | 事件实时显示 |

#### 验收标准
- 能看到2D地图和建筑物
- 能看到智能体在地图上移动
- 能看到实时事件流

---

### 阶段6: 前端完善 (第18-22天)

**目标**: 完善观察界面,增加详情和统计

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 依赖 | 验收标准 |
|--------|----------|----------|------|----------|
| 6.1 | 实现对话气泡 | 4小时 | 5.7 | 气泡可显示 |
| 6.2 | 实现智能体详情面板 | 4小时 | 5.11 | 详情完整 |
| 6.3 | 实现性格/状态可视化 | 2小时 | 6.2 | 进度条等 |
| 6.4 | 实现关系列表 | 2小时 | 6.2 | 关系可见 |
| 6.5 | 实现记忆列表 | 2小时 | 6.2 | 记忆可见 |
| 6.6 | 实现统计面板 | 4小时 | 5.9 | 统计数据显示 |
| 6.7 | 实现职业分布图 | 2小时 | 6.6 | 饼图可见 |
| 6.8 | 实现社交网络图 | 6小时 | 5.9 | 力导向图可交互 |
| 6.9 | 实现时间控制(暂停/加速) | 2小时 | 5.3 | 控制可用 |
| 6.10 | 实现跟随智能体功能 | 2小时 | 5.7 | 地图跟随 |
| 6.11 | UI美化和动画 | 4小时 | 6.1-6.10 | 视觉效果好 |
| 6.12 | 响应式适配 | 2小时 | 6.11 | 多设备可用 |

#### 验收标准
- 点击智能体能看到完整详情
- 能看到社交网络关系图
- 界面美观,交互流畅

---

### 阶段7: 记忆与存储 (第22-25天)

**目标**: 实现持久化存储和记忆系统

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 依赖 | 验收标准 |
|--------|----------|----------|------|----------|
| 7.1 | 设计数据库Schema | 2小时 | - | ER图完整 |
| 7.2 | 实现SQLAlchemy模型 | 4小时 | 7.1 | 模型完整 |
| 7.3 | 实现Alembic迁移 | 2小时 | 7.2 | 迁移可执行 |
| 7.4 | 实现智能体CRUD | 3小时 | 7.2 | 增删改查可用 |
| 7.5 | 实现对话存储 | 2小时 | 7.2 | 对话可存储 |
| 7.6 | 实现关系存储 | 2小时 | 7.2 | 关系可存储 |
| 7.7 | 集成Qdrant向量库 | 3小时 | - | 向量库可用 |
| 7.8 | 实现记忆向量化存储 | 4小时 | 7.7 | 记忆可存储 |
| 7.9 | 实现记忆检索 | 3小时 | 7.8 | 相关记忆可检索 |
| 7.10 | 实现世界状态保存/恢复 | 3小时 | 7.4-7.6 | 重启可恢复 |
| 7.11 | 实现数据导出API | 3小时 | 7.4-7.6 | CSV/JSON导出 |

#### 验收标准
- 服务重启后世界状态能恢复
- 智能体能检索相关记忆
- 数据能导出为CSV/JSON

---

### 阶段8: 自动扩展 (第25-28天)

**目标**: 实现智能体自动创建和社会平衡

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 依赖 | 验收标准 |
|--------|----------|----------|------|----------|
| 8.1 | 实现职业缺口检测 | 3小时 | 3.x | 能检测缺口 |
| 8.2 | 实现社交孤岛检测 | 2小时 | 4.x | 能检测孤独者 |
| 8.3 | 实现人口平衡检测 | 2小时 | 3.x | 能检测失衡 |
| 8.4 | 实现AI生成新智能体 | 4小时 | 2.x, 3.10 | 能生成角色 |
| 8.5 | 实现智能体融入逻辑 | 3小时 | 8.4 | 新人能融入 |
| 8.6 | 实现智能体离开机制 | 2小时 | 3.x | 条件满足离开 |
| 8.7 | 实现人口上限控制 | 1小时 | 8.4-8.6 | 人口可控 |
| 8.8 | 实现定时检查任务 | 2小时 | 8.1-8.3 | 定时执行 |
| 8.9 | 前端显示新增/离开事件 | 2小时 | 8.4-8.6 | 事件可见 |

#### 验收标准
- 咖啡馆人多时会自动创建服务员
- 孤独的智能体会获得匹配的朋友
- 系统能维持健康的人口结构

---

### 阶段9: 部署与开源 (第28-30天)

**目标**: 完成部署和开源准备

#### 任务清单

| 任务ID | 任务描述 | 预计时间 | 依赖 | 验收标准 |
|--------|----------|----------|------|----------|
| 9.1 | 编写Dockerfile(后端) | 2小时 | - | 镜像可构建 |
| 9.2 | 编写Dockerfile(前端) | 1小时 | - | 镜像可构建 |
| 9.3 | 完善docker-compose.yml | 2小时 | 9.1-9.2 | 一键启动 |
| 9.4 | 编写部署文档 | 3小时 | 9.3 | 文档清晰 |
| 9.5 | 配置云服务器 | 2小时 | - | 服务器就绪 |
| 9.6 | 部署到云服务器 | 2小时 | 9.3-9.5 | 线上可访问 |
| 9.7 | 配置域名和HTTPS | 1小时 | 9.6 | HTTPS可用 |
| 9.8 | 代码注释完善 | 4小时 | - | 注释完整 |
| 9.9 | 编写README.md | 2小时 | - | README完整 |
| 9.10 | 编写CONTRIBUTING.md | 1小时 | - | 贡献指南完整 |
| 9.11 | 创建Issues模板 | 30分钟 | - | 模板可用 |
| 9.12 | 首次发布Release | 1小时 | 9.1-9.11 | v0.1.0发布 |

#### 验收标准
- 线上服务稳定运行
- 任何人可以按README部署
- GitHub仓库开源就绪

---

## 里程碑

| 里程碑 | 日期 | 交付物 |
|--------|------|--------|
| M0: 项目启动 | 第1天 | GitHub仓库,开发环境 |
| M1: 核心框架 | 第5天 | 后端框架+LLM集成 |
| M2: 智能体可运行 | 第10天 | 智能体能自主活动 |
| M3: 对话可观察 | 第14天 | 智能体能对话 |
| M4: 前端可用 | 第18天 | 基础观察界面 |
| M5: 功能完整 | 第25天 | 完整观察体验 |
| M6: 开源发布 | 第30天 | v0.1.0发布 |

## 风险与应对

| 风险 | 可能性 | 影响 | 应对措施 |
|------|--------|------|----------|
| LLM调用成本超预算 | 中 | 高 | 增加规则决策比例,减少LLM调用 |
| 性能问题(50智能体卡顿) | 中 | 中 | 优化决策频率,分批处理 |
| 对话质量不佳 | 中 | 中 | 优化提示词,增加上下文 |
| 前端渲染性能 | 低 | 中 | 只渲染可见区域,使用对象池 |
| DeepSeek API不稳定 | 低 | 高 | 增加重试机制,备用模型 |

## 后续迭代(v0.2+)

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 天气系统 | P2 | 天气影响智能体行为 |
| 节日活动 | P2 | 春节/圣诞等特殊事件 |
| 智能体创业 | P2 | 智能体可以开店 |
| 多语言支持 | P3 | 英文界面 |
| 移动端适配 | P3 | 手机观看 |
| 数据分析面板 | P2 | 更丰富的统计图表 |
| 时间回放 | P3 | 回放历史事件 |
| 社区贡献智能体 | P2 | 用户可以贡献角色模板 |

---

## 现在开始

**第一步**: 创建GitHub仓库并初始化项目结构

准备好了吗？告诉我,我立刻开始执行!
