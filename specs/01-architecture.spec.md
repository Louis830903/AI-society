# 系统架构规格说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        观察者（浏览器）                           │
│                     React + Pixi.js + TailwindCSS               │
└─────────────────────────────────────────────────────────────────┘
                                ▲
                                │ WebSocket (实时事件流)
                                │ REST API (查询/控制)
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        API网关层 (FastAPI)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ REST路由    │  │ WebSocket   │  │ 后台任务调度 (APScheduler)│  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                ▲
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        核心引擎层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ 世界引擎    │  │ 智能体引擎  │  │ 事件总线 (EventBus)      │  │
│  │ WorldEngine │  │ AgentEngine │  │                         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ 对话引擎    │  │ 经济引擎    │  │ 记忆引擎                 │  │
│  │ ChatEngine  │  │ EconomyEngine│ │ MemoryEngine            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                ▲
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        LLM抽象层                                 │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                  LLMRouter (多模型路由)                   │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │    │
│  │  │DeepSeek  │  │OpenAI    │  │Claude    │  │本地模型   │ │    │
│  │  │Chat/R1   │  │GPT-4o    │  │Sonnet    │  │Ollama    │ │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘ │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                ▲
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据持久层                                │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ PostgreSQL  │  │ Qdrant      │  │ Redis                   │  │
│  │ 结构化数据  │  │ 向量记忆    │  │ 缓存+消息队列           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 技术栈选型

### 后端
| 组件 | 技术选型 | 选型理由 |
|------|----------|----------|
| Web框架 | FastAPI | 异步原生、类型安全、性能强、自动文档 |
| 任务调度 | APScheduler | 轻量、支持异步、易集成 |
| ORM | SQLAlchemy 2.0 | 异步支持、成熟稳定、类型友好 |
| 数据库 | PostgreSQL 15 | 稳定可靠、JSON支持好、扩展性强 |
| 向量库 | Qdrant | 开源免费、性能好、易部署 |
| 缓存/队列 | Redis | 标准方案、稳定可靠 |
| 容器化 | Docker + Docker Compose | 标准化部署、环境一致 |

### 前端
| 组件 | 技术选型 | 选型理由 |
|------|----------|----------|
| 框架 | React 18 | 生态成熟、社区大、便于开源贡献 |
| 构建 | Vite | 快速开发体验、现代化 |
| 2D渲染 | Pixi.js 8 | 性能强、WebGL加速、适合大量精灵 |
| 状态管理 | Zustand | 轻量简洁、低耦合 |
| 样式 | TailwindCSS | 快速开发、一致性好 |
| 实时通信 | WebSocket原生 | 简单可靠 |
| 图表 | Recharts | React生态、简单够用 |

### LLM集成

| 模型 | 用途 | 定价 | 说明 |
|------|------|------|------|
| **DeepSeek R1** | **默认模型** | $0.55/百万token(输入) | 推理能力强，智能体默认使用 |
| DeepSeek Chat | 备选模型 | $0.14/百万token | 便宜，可手动切换 |
| OpenAI GPT-4o | 可选高端 | $2.5/百万token | 预留接口 |
| Claude Sonnet | 可选高端 | $3/百万token | 预留接口 |
| Ollama本地 | 开发测试 | 免费 | 本地部署 |

**重要设计决策**：
- 所有智能体默认使用 DeepSeek R1（推理模型）
- 所有行为决策都由AI做出，不使用规则引擎
- 月度预算：$200 USD
- 支持运行时修改单个智能体的模型

## 目录结构

```
ai-society/
├── backend/                    # Python后端
│   ├── app/
│   │   ├── __init__.py        # FastAPI应用工厂
│   │   ├── main.py            # 入口文件
│   │   ├── core/              # 核心模块
│   │   │   ├── config.py      # 配置管理
│   │   │   ├── world.py       # 世界引擎
│   │   │   ├── agent.py       # 智能体核心
│   │   │   ├── economy.py     # 经济系统
│   │   │   ├── memory.py      # 记忆系统
│   │   │   └── events.py      # 事件总线
│   │   ├── llm/               # LLM抽象层
│   │   │   ├── router.py      # 多模型路由
│   │   │   ├── deepseek.py    # DeepSeek适配器
│   │   │   ├── openai.py      # OpenAI适配器
│   │   │   └── prompts.py     # 提示词模板
│   │   ├── services/          # 业务服务
│   │   │   ├── world_service.py
│   │   │   ├── agent_service.py
│   │   │   ├── chat_service.py
│   │   │   └── spawn_service.py  # 智能体创建服务
│   │   ├── routes/            # API路由
│   │   │   ├── world.py
│   │   │   ├── agents.py
│   │   │   └── stream.py      # WebSocket
│   │   ├── models/            # 数据库模型
│   │   │   ├── agent.py
│   │   │   ├── event.py
│   │   │   ├── conversation.py
│   │   │   └── relationship.py
│   │   └── schemas/           # Pydantic模型
│   │       ├── agent.py
│   │       └── event.py
│   ├── data/                  # 初始数据
│   │   ├── locations.json     # 地图位置数据
│   │   ├── occupations.json   # 职业配置
│   │   └── seed_agents.json   # 初始智能体模板
│   ├── tests/                 # 测试
│   ├── alembic/               # 数据库迁移
│   ├── requirements.txt
│   └── Dockerfile
│
├── frontend/                  # React前端
│   ├── src/
│   │   ├── App.tsx
│   │   ├── main.tsx
│   │   ├── components/        # UI组件
│   │   │   ├── WorldMap.tsx   # Pixi.js地图
│   │   │   ├── AgentSprite.tsx
│   │   │   ├── AgentPanel.tsx
│   │   │   ├── EventStream.tsx
│   │   │   └── StatsPanel.tsx
│   │   ├── stores/            # Zustand状态
│   │   │   ├── worldStore.ts
│   │   │   └── agentStore.ts
│   │   ├── hooks/             # 自定义hooks
│   │   │   └── useWebSocket.ts
│   │   ├── utils/
│   │   └── types/
│   ├── public/
│   │   └── assets/            # 精灵图、地图素材
│   ├── package.json
│   ├── vite.config.ts
│   └── Dockerfile
│
├── specs/                     # 规格说明文档
│   ├── 00-project-overview.spec.md
│   ├── 01-architecture.spec.md
│   └── ...
│
├── docker-compose.yml         # 一键启动
├── .env.example               # 环境变量模板
└── LICENSE                    # OpenRAIL协议
```

## 数据流

### 世界循环（主循环）

```
每游戏内10分钟（现实1分钟）执行一次:

1. 时间推进
   └─> 更新世界时钟
   └─> 触发定时事件（日出/日落/发工资等）

2. 智能体更新（并行处理）
   ├─> 需求衰减（能量-5，社交-3等）
   ├─> 经济结算（收入/支出）
   └─> 行为决策
       ├─> 简单决策（规则引擎）
       └─> 复杂决策（调用LLM）

3. 社交互动
   └─> 检测近距离智能体
   └─> 触发对话

4. 事件广播
   └─> 通过EventBus推送到WebSocket
   └─> 前端实时更新
```

### LLM调用流程

```
智能体需要决策时:

1. AgentEngine 构建上下文
   └─> 收集环境信息
   └─> 检索相关记忆
   └─> 组装提示词

2. LLMRouter 路由到对应模型
   └─> 根据agent.model_name选择模型
   └─> 调用对应适配器

3. 解析响应
   └─> 提取动作/目标/原因
   └─> 验证合法性

4. 执行决策
   └─> 更新智能体状态
   └─> 记录到记忆系统
   └─> 广播事件
```

## 扩展性设计

### 新增LLM模型
1. 在 `llm/` 下新建适配器文件
2. 实现统一的 `LLMAdapter` 接口
3. 在 `LLMRouter` 中注册

### 新增智能体行为
1. 在 `core/agent.py` 的 `ActionType` 枚举中添加
2. 在 `AgentEngine` 中实现行为逻辑
3. 更新提示词模板

### 新增地图区域
1. 在 `data/locations.json` 中添加配置
2. 前端自动渲染

## 性能指标目标

| 指标 | 目标值 |
|------|--------|
| 智能体数量 | 50-200 |
| 前端帧率 | 60fps |
| API响应时间 | <100ms |
| WebSocket延迟 | <50ms |
| LLM调用频率 | 每智能体每10分钟(游戏内)最多1次 |
| 内存占用 | <2GB |
